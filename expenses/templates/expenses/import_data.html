{% extends 'expenses/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-8">
        
        <div class="card shadow-sm" id="inputSection" {% if preview_data %}style="display:none;"{% endif %}>
            <div class="card-body p-5 text-center">
                <div class="mb-4">
                    <span style="font-size: 3rem;">üìÇ</span>
                    <h3 class="fw-bold text-primary mt-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                    <p class="text-muted">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx), CSV ‡πÅ‡∏•‡∏∞ Text</p>
                </div>

                <div class="alert alert-info text-start small mb-4">
                    <b class="fs-5 mb-1">üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå:</b><br>
                    <ul class="mb-0 mt-1 pl-3">
                        <li><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> ‡πÄ‡∏ä‡πà‡∏ô 12/01/2025</li>
                        <li><b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</b> ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£</li>
                        <li><b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</b> ‡πÄ‡∏ä‡πà‡∏ô -50 ‡∏´‡∏£‡∏∑‡∏≠ 1000</li>
                    </ul>
                    <div style="height: 20px;"></div>
                    <div class="d-flex flex-column gap-2">
                            <span class="small fs-5 fw-bold text-secondary">üì• ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:</span>
                            <div class="btn-group shadow-sm mx-4 ">
                                <a href="{% url 'download_template' %}?format=xlsx" class="btn btn-sm btn-light border text-success fw-bold">Excel</a>
                                <a href="{% url 'download_template' %}?format=csv" class="btn btn-sm btn-light border text-primary fw-bold">CSV</a>
                                <a href="{% url 'download_template' %}?format=txt" class="btn btn-sm btn-light border text-dark fw-bold">Text</a>
                            </div>
                        </div>
                </div>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-4 text-start">
                        {{ form.file }}
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2 fw-bold shadow-sm">
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå
                    </button>
                </form>
            </div>
        </div>

        <div class="card shadow-sm" id="previewSection" {% if not preview_data %}style="display:none;"{% endif %}>
            <div class="card-body p-4">
                <h4 class="fw-bold text-primary mb-3">üîé ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</h4>
                <p class="text-muted small">‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>

                <div class="table-responsive mb-3" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                                <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="d-flex gap-2">
                    <form method="post" id="confirmForm" class="w-50">
                        {% csrf_token %}
                        <input type="hidden" name="confirm_save" value="true">
                        <input type="hidden" name="final_data" id="finalDataInput">
                        <button type="button" onclick="submitData()" class="btn btn-success w-100 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                    <a href="" class="btn btn-light border w-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editRowModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-primary">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editIndex">
                <div class="mb-3">
                    <label class="small fw-bold text-secondary">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="editDate" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-secondary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                    <input type="text" id="editDesc" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-secondary">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                    <input type="number" id="editAmount" step="0.01" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="small fw-bold text-secondary">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                    <select id="editCat" class="form-select">
                        <option value="">- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ -</option>
                        <optgroup label="üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">
                            {% for cat in income_cats %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="üì§ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢">
                            {% for cat in expense_cats %}
                                <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </optgroup>
                    </select>
                </div>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-primary w-100 rounded-pill" onclick="saveEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deletePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <span style="font-size: 3rem;">üóëÔ∏è</span>
                </div>
                <h5 class="fw-bold mb-2">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</h5>
                <p class="text-muted small mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-danger rounded-pill px-3 fw-bold" onclick="confirmDelete()">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% if preview_data %}
    {{ preview_data|json_script:"preview-data-source" }}
{% endif %}


<script>
    let tableData = [];
    let editModal = null;
    let deleteModal = null; // 1. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö Modal ‡∏•‡∏ö
    let indexToDelete = null; // 2. ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≥‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÑ‡∏´‡∏ô

    document.addEventListener("DOMContentLoaded", function() {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Preview
        const dataScript = document.getElementById('preview-data-source');
        if (dataScript) {
            try {
                tableData = JSON.parse(dataScript.textContent);
                renderTable();
            } catch (e) {
                console.error("Error parsing JSON:", e);
            }
        }

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        const editModalEl = document.getElementById('editRowModal');
        if (editModalEl) {
            editModal = new bootstrap.Modal(editModalEl);
        }

        // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° Modal ‡∏•‡∏ö
        const deleteModalEl = document.getElementById('deletePreviewModal');
        if (deleteModalEl) {
            deleteModal = new bootstrap.Modal(deleteModalEl);
        }
    });

    function renderTable() {
        const tbody = document.getElementById('previewTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        tableData.forEach((row, index) => {
            let colorClass = row.amount < 0 ? 'text-danger' : 'text-success';
            let catBadge = (row.category_name && row.category_name !== '-' && row.category_name !== 'None')
                ? `<span class="badge bg-light text-dark border">${row.category_name}</span>` 
                : `<span class="text-muted small">-</span>`;

            let tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="small">${row.date}</td>
                <td class="fw-bold">${row.description}</td>
                <td class="${colorClass} fw-bold">${parseFloat(row.amount).toFixed(2)}</td>
                <td>${catBadge}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-warning rounded-circle p-1" onclick="openEdit(${index})" style="width:30px;height:30px;">‚úèÔ∏è</button>
                    <button type="button" class="btn btn-sm btn-outline-danger rounded-circle p-1 ms-1" onclick="openDeleteModal(${index})" style="width:30px;height:30px;">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î Modal ‡∏•‡∏ö
    function openDeleteModal(index) {
        if (!deleteModal) return;
        indexToDelete = index; // ‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà
        deleteModal.show();    // ‡πÄ‡∏õ‡∏¥‡∏î Modal
    }

    // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö (‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏î‡∏á‡πÉ‡∏ô Modal)
    function confirmDelete() {
        if (indexToDelete !== null) {
            tableData.splice(indexToDelete, 1); // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Array
            renderTable(); // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            deleteModal.hide(); // ‡∏õ‡∏¥‡∏î Modal
            indexToDelete = null; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤
        }
    }

    function openEdit(index) {
        if (!editModal) return;

        const row = tableData[index];
        document.getElementById('editIndex').value = index;
        document.getElementById('editDate').value = row.date;
        document.getElementById('editDesc').value = row.description;
        document.getElementById('editAmount').value = row.amount;
        
        const catSelect = document.getElementById('editCat');
        catSelect.value = row.category_id || "";

        editModal.show();
    }

    function saveEdit() {
        const index = document.getElementById('editIndex').value;
        const catSelect = document.getElementById('editCat');
        
        tableData[index] = {
            date: document.getElementById('editDate').value,
            description: document.getElementById('editDesc').value,
            amount: parseFloat(document.getElementById('editAmount').value),
            category_id: catSelect.value,
            category_name: catSelect.options[catSelect.selectedIndex].text
        };
        
        if (tableData[index].category_id === "") {
            tableData[index].category_name = "-";
        }

        renderTable();
        editModal.hide();
    }

    function submitData() {
        if (tableData.length === 0) {
            alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            return;
        }
        document.getElementById('finalDataInput').value = JSON.stringify(tableData);
        document.getElementById('confirmForm').submit();
    }
</script>
{% endblock %}