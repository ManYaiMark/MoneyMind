{% extends "expenses/base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
        <div class="d-flex gap-2">
            <button type="button" id="bulkDeleteBtn" class="btn btn-danger shadow-sm d-none" data-bs-toggle="modal" data-bs-target="#bulkDeleteModal">
                ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (<span id="selectedCount">0</span>)
            </button>
            <a href="{% url 'add_smart_transaction' %}" class="btn btn-primary shadow-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</a>
        </div>
    </div>

    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4" style="width: 5%;">
                                <input type="checkbox" id="selectAll" class="form-check-input" style="cursor: pointer;">
                            </th>
                            <th class="ps-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th class="text-end">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for txn in transactions %}
                        <tr>
                            <td class="ps-4">
                                <input type="checkbox" class="form-check-input txn-checkbox" value="{{ txn.id }}" style="cursor: pointer;">
                            </td>
                            <td class="ps-2 text-secondary small">{{ txn.date|date:"d M Y" }}</td>
                            <td class="fw-bold">{{ txn.description }}</td>
                            <td>
                                {% if txn.category %}
                                    <span class="badge bg-light text-dark border">{{ txn.category.name }}</span>
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end fw-bold {% if txn.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ txn.amount|floatformat:2 }}
                            </td>
                            <td class="text-center">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-warning rounded-circle btn-edit"
                                        style="width: 32px; height: 32px; padding: 0; line-height: 30px;"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editModal"
                                        data-id="{{ txn.id }}"
                                        data-date="{{ txn.date|date:'Y-m-d' }}"
                                        data-desc="{{ txn.description }}"
                                        data-amount="{{ txn.amount }}"
                                        data-cat="{{ txn.category.id|default:'' }}">
                                    ‚úèÔ∏è
                                </button>
                                
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger rounded-circle ms-1 btn-delete"
                                        style="width: 32px; height: 32px; padding: 0; line-height: 30px;"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteModal"
                                        data-id="{{ txn.id }}">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold text-primary">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <form id="editForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" name="date" id="editDate" class="form-control rounded-3" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" name="description" id="editDesc" class="form-control rounded-3" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡∏¥‡∏î‡∏•‡∏ö=‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢)</label>
                        <input type="number" step="0.01" name="amount" id="editAmount" class="form-control rounded-3" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold text-secondary">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                        <select name="category" id="editCategory" class="form-select rounded-3">
                            <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                            <optgroup label="üì• ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">
                                {% for cat in income_cats %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </optgroup>
                            <optgroup label="üì§ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢">
                                {% for cat in expense_cats %}
                                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                                {% endfor %}
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    <button type="button" class="btn btn-light text-secondary rounded-pill px-4" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div style="height: 30px;"></div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <span style="font-size: 3rem;">üóëÔ∏è</span>
                </div>
                <h5 class="fw-bold mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h5>
                <p class="text-muted small mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p>
                
                <div class="d-flex gap-2 justify-content-center">
                    <a href="#" id="confirmDeleteBtn" class="btn btn-danger rounded-pill px-3 fw-bold">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</a>
                    <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-body text-center p-4">
                <div class="mb-3">
                    <span style="font-size: 3rem;">üî•</span>
                </div>
                <h5 class="fw-bold mb-2">‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?</h5>
                <p class="text-muted small mb-4">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏•‡∏ö <span id="bulkDeleteCount" class="fw-bold text-danger">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                
                <form method="post" action="{% url 'delete_multiple_transactions' %}" id="bulkDeleteForm">
                    {% csrf_token %}
                    <div id="bulkDeleteInputs"></div>
                    
                    <div class="d-flex gap-2 justify-content-center">
                        <button type="submit" class="btn btn-danger rounded-pill px-3 fw-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button type="button" class="btn btn-light rounded-pill px-3" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        
        var editModal = document.getElementById('editModal');
        editModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; 
            
            var id = button.getAttribute('data-id');
            var date = button.getAttribute('data-date');
            var desc = button.getAttribute('data-desc');
            var amount = button.getAttribute('data-amount');
            var catId = button.getAttribute('data-cat');

            document.getElementById('editDate').value = date;
            document.getElementById('editDesc').value = desc;
            document.getElementById('editAmount').value = amount;
            document.getElementById('editCategory').value = catId;

            var form = document.getElementById('editForm');
            form.action = "{% url 'edit_transaction' 0 %}".replace('0', id);
        });

        var deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-id');

            var confirmBtn = document.getElementById('confirmDeleteBtn');
            confirmBtn.href = "{% url 'delete_transaction' 0 %}".replace('0', id);
        });

        const selectAllCheckbox = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.txn-checkbox');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectedCountSpan = document.getElementById('selectedCount');
        const bulkDeleteInputs = document.getElementById('bulkDeleteInputs');
        const bulkDeleteCount = document.getElementById('bulkDeleteCount');

        function updateBulkDeleteButton() {
            const selected = document.querySelectorAll('.txn-checkbox:checked');
            const count = selected.length;
            
            selectedCountSpan.innerText = count;
            bulkDeleteCount.innerText = count;
            
            if (count > 0) {
                bulkDeleteBtn.classList.remove('d-none');
            } else {
                bulkDeleteBtn.classList.add('d-none');
            }
        }

        selectAllCheckbox.addEventListener('change', function() {
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
            });
            updateBulkDeleteButton();
        });

        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateBulkDeleteButton);
        });

        const bulkDeleteModal = document.getElementById('bulkDeleteModal');
        bulkDeleteModal.addEventListener('show.bs.modal', function() {
            bulkDeleteInputs.innerHTML = '';
            
            document.querySelectorAll('.txn-checkbox:checked').forEach(cb => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'transaction_ids';
                input.value = cb.value;
                bulkDeleteInputs.appendChild(input);
            });
        });

    });
</script>

{% endblock %}